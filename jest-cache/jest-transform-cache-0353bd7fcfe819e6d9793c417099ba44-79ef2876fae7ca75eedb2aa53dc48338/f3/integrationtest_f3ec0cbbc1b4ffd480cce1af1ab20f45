aaddcf57f5c645ff5881626c6f8491ea
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const index_1 = require("../../index");
const DeepSeekService_1 = require("../../core/DeepSeekService");
describe('DeepSeek AI Integration', () => {
    const mockConfig = {
        apiKey: process.env.JSONSAGE_DEEPSEEK_API_KEY || 'test-api-key'
    };
    const mockJsonData = {
        user: {
            name: 'John Doe',
            age: 30,
            email: 'john@example.com',
            preferences: {
                theme: 'dark',
                notifications: true
            }
        },
        settings: {
            language: 'en',
            timezone: 'UTC-5'
        }
    };
    describe('End-to-End Schema Generation', () => {
        it('should generate schema with AI when enabled', async () => {
            const workflow = index_1.json.createWorkflow({
                schema: {
                    useAI: true,
                    deepseek: mockConfig
                }
            });
            const schema = await workflow.generateSchema(mockJsonData, {
                format: 'draft-07',
                includeExamples: true,
                includeDescriptions: true
            });
            expect(schema).toBeDefined();
            const parsedSchema = JSON.parse(schema);
            expect(parsedSchema.$schema).toBe('http://json-schema.org/draft-07/schema#');
            expect(parsedSchema.properties).toBeDefined();
            expect(parsedSchema.properties.user).toBeDefined();
            expect(parsedSchema.properties.settings).toBeDefined();
        });
        it('should fall back to traditional generation when AI is disabled', async () => {
            const workflow = index_1.json.createWorkflow({
                schema: {
                    useAI: false
                }
            });
            const schema = await workflow.generateSchema(mockJsonData);
            expect(schema).toBeDefined();
            const parsedSchema = JSON.parse(schema);
            expect(parsedSchema.type).toBe('object');
            expect(parsedSchema.properties).toBeDefined();
        });
    });
    describe('Schema Generator Features', () => {
        let generator;
        beforeEach(() => {
            generator = index_1.json.createSchemaGenerator({
                useAI: true,
                deepseek: mockConfig
            });
        });
        it('should generate schema with examples', async () => {
            const schema = await generator.generateSchema(mockJsonData, {
                includeExamples: true
            });
            const parsedSchema = JSON.parse(schema);
            expect(parsedSchema.examples).toBeDefined();
            // 验证示例值的结构
            if (parsedSchema.examples && parsedSchema.examples.length > 0) {
                const example = parsedSchema.examples[0];
                expect(example.user).toBeDefined();
                expect(example.settings).toBeDefined();
            }
        });
        it('should generate schema with descriptions', async () => {
            const schema = await generator.generateSchema(mockJsonData, {
                includeDescriptions: true
            });
            const parsedSchema = JSON.parse(schema);
            // 验证描述字段
            expect(parsedSchema.properties.user.description).toBeDefined();
            expect(parsedSchema.properties.settings.description).toBeDefined();
        });
        it('should handle complex nested objects', async () => {
            const complexData = {
                data: {
                    items: [
                        { id: 1, value: 'test' },
                        { id: 2, value: 'test2' }
                    ],
                    metadata: {
                        created: '2025-01-16T14:34:08+08:00',
                        tags: ['tag1', 'tag2']
                    }
                }
            };
            const schema = await generator.generateSchema(complexData);
            const parsedSchema = JSON.parse(schema);
            expect(parsedSchema.properties.data).toBeDefined();
            expect(parsedSchema.properties.data.properties.items).toBeDefined();
            expect(parsedSchema.properties.data.properties.metadata).toBeDefined();
        });
    });
    describe('DeepSeek Service Integration', () => {
        let service;
        beforeEach(() => {
            service = new DeepSeekService_1.DeepSeekService(mockConfig);
        });
        it('should generate field descriptions', async () => {
            const descriptions = await service.generateFieldDescriptions(mockJsonData);
            expect(descriptions).toBeDefined();
            expect(descriptions['user.name']).toBeDefined();
            expect(descriptions['user.email']).toBeDefined();
        });
        it('should generate examples', async () => {
            const schema = await service.generateSchema(mockJsonData);
            const examples = await service.generateExamples(schema);
            expect(examples).toBeDefined();
            expect(examples.user).toBeDefined();
            expect(examples.settings).toBeDefined();
        });
        it('should handle errors gracefully', async () => {
            const invalidJson = '{invalid json}';
            await expect(service.generateSchema(invalidJson))
                .rejects.toThrow();
        });
    });
    describe('Caching Behavior', () => {
        it('should cache schema generation results', async () => {
            const generator = index_1.json.createSchemaGenerator({
                useAI: true,
                deepseek: mockConfig,
                caching: true
            });
            // 第一次生成
            const schema1 = await generator.generateSchema(mockJsonData);
            // 第二次生成（应该使用缓存）
            const schema2 = await generator.generateSchema(mockJsonData);
            expect(schema1).toBe(schema2);
        });
        it('should respect cache settings', async () => {
            const generator = index_1.json.createSchemaGenerator({
                useAI: true,
                deepseek: mockConfig,
                caching: false
            });
            // 禁用缓存时，每次生成的 Schema 可能略有不同
            const schema1 = await generator.generateSchema(mockJsonData);
            const schema2 = await generator.generateSchema(mockJsonData);
            // 由于 AI 生成的内容可能略有差异，我们只比较基本结构
            const parsed1 = JSON.parse(schema1);
            const parsed2 = JSON.parse(schema2);
            expect(parsed1.$schema).toBe(parsed2.$schema);
            expect(Object.keys(parsed1.properties)).toEqual(Object.keys(parsed2.properties));
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxob25ncGluZ1xcQ2FzY2FkZVByb2plY3RzXFxqc29uLXNhZ2UtYWktYWdlbnRcXHNyY1xcX190ZXN0c19fXFxkZWVwc2Vla1xcaW50ZWdyYXRpb24udGVzdC50cyIsIm1hcHBpbmdzIjoiOztBQUFBLHVDQUFtQztBQUVuQyxnRUFBNkQ7QUFFN0QsUUFBUSxDQUFDLHlCQUF5QixFQUFFLEdBQUcsRUFBRTtJQUNyQyxNQUFNLFVBQVUsR0FBRztRQUNmLE1BQU0sRUFBRSxPQUFPLENBQUMsR0FBRyxDQUFDLHlCQUF5QixJQUFJLGNBQWM7S0FDbEUsQ0FBQztJQUVGLE1BQU0sWUFBWSxHQUFHO1FBQ2pCLElBQUksRUFBRTtZQUNGLElBQUksRUFBRSxVQUFVO1lBQ2hCLEdBQUcsRUFBRSxFQUFFO1lBQ1AsS0FBSyxFQUFFLGtCQUFrQjtZQUN6QixXQUFXLEVBQUU7Z0JBQ1QsS0FBSyxFQUFFLE1BQU07Z0JBQ2IsYUFBYSxFQUFFLElBQUk7YUFDdEI7U0FDSjtRQUNELFFBQVEsRUFBRTtZQUNOLFFBQVEsRUFBRSxJQUFJO1lBQ2QsUUFBUSxFQUFFLE9BQU87U0FDcEI7S0FDSixDQUFDO0lBRUYsUUFBUSxDQUFDLDhCQUE4QixFQUFFLEdBQUcsRUFBRTtRQUMxQyxFQUFFLENBQUMsNkNBQTZDLEVBQUUsS0FBSyxJQUFJLEVBQUU7WUFDekQsTUFBTSxRQUFRLEdBQUcsWUFBSSxDQUFDLGNBQWMsQ0FBQztnQkFDakMsTUFBTSxFQUFFO29CQUNKLEtBQUssRUFBRSxJQUFJO29CQUNYLFFBQVEsRUFBRSxVQUFVO2lCQUN2QjthQUNKLENBQUMsQ0FBQztZQUVILE1BQU0sTUFBTSxHQUFHLE1BQU0sUUFBUSxDQUFDLGNBQWMsQ0FBQyxZQUFZLEVBQUU7Z0JBQ3ZELE1BQU0sRUFBRSxVQUFVO2dCQUNsQixlQUFlLEVBQUUsSUFBSTtnQkFDckIsbUJBQW1CLEVBQUUsSUFBSTthQUM1QixDQUFDLENBQUM7WUFFSCxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUMsV0FBVyxFQUFFLENBQUM7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QUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1lBQzlDLE1BQU0sQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FDM0MsTUFBTSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsVUFBVSxDQUFDLENBQ2xDLENBQUM7UUFDTixDQUFDLENBQUMsQ0FBQztJQUNQLENBQUMsQ0FBQyxDQUFDO0FBQ1AsQ0FBQyxDQUFDLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiQzpcXFVzZXJzXFxob25ncGluZ1xcQ2FzY2FkZVByb2plY3RzXFxqc29uLXNhZ2UtYWktYWdlbnRcXHNyY1xcX190ZXN0c19fXFxkZWVwc2Vla1xcaW50ZWdyYXRpb24udGVzdC50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBqc29uIH0gZnJvbSAnLi4vLi4vaW5kZXgnO1xyXG5pbXBvcnQgeyBTY2hlbWFHZW5lcmF0b3IgfSBmcm9tICcuLi8uLi9jb3JlL1NjaGVtYUdlbmVyYXRvcic7XHJcbmltcG9ydCB7IERlZXBTZWVrU2VydmljZSB9IGZyb20gJy4uLy4uL2NvcmUvRGVlcFNlZWtTZXJ2aWNlJztcclxuXHJcbmRlc2NyaWJlKCdEZWVwU2VlayBBSSBJbnRlZ3JhdGlvbicsICgpID0+IHtcclxuICAgIGNvbnN0IG1vY2tDb25maWcgPSB7XHJcbiAgICAgICAgYXBpS2V5OiBwcm9jZXNzLmVudi5KU09OU0FHRV9ERUVQU0VFS19BUElfS0VZIHx8ICd0ZXN0LWFwaS1rZXknXHJcbiAgICB9O1xyXG5cclxuICAgIGNvbnN0IG1vY2tKc29uRGF0YSA9IHtcclxuICAgICAgICB1c2VyOiB7XHJcbiAgICAgICAgICAgIG5hbWU6ICdKb2huIERvZScsXHJcbiAgICAgICAgICAgIGFnZTogMzAsXHJcbiAgICAgICAgICAgIGVtYWlsOiAnam9obkBleGFtcGxlLmNvbScsXHJcbiAgICAgICAgICAgIHByZWZlcmVuY2VzOiB7XHJcbiAgICAgICAgICAgICAgICB0aGVtZTogJ2RhcmsnLFxyXG4gICAgICAgICAgICAgICAgbm90aWZpY2F0aW9uczogdHJ1ZVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSxcclxuICAgICAgICBzZXR0aW5nczoge1xyXG4gICAgICAgICAgICBsYW5ndWFnZTogJ2VuJyxcclxuICAgICAgICAgICAgdGltZXpvbmU6ICdVVEMtNSdcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG5cclxuICAgIGRlc2NyaWJlKCdFbmQtdG8tRW5kIFNjaGVtYSBHZW5lcmF0aW9uJywgKCkgPT4ge1xyXG4gICAgICAgIGl0KCdzaG91bGQgZ2VuZXJhdGUgc2NoZW1hIHdpdGggQUkgd2hlbiBlbmFibGVkJywgYXN5bmMgKCkgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCB3b3JrZmxvdyA9IGpzb24uY3JlYXRlV29ya2Zsb3coe1xyXG4gICAgICAgICAgICAgICAgc2NoZW1hOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgdXNlQUk6IHRydWUsXHJcbiAgICAgICAgICAgICAgICAgICAgZGVlcHNlZWs6IG1vY2tDb25maWdcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICBjb25zdCBzY2hlbWEgPSBhd2FpdCB3b3JrZmxvdy5nZW5lcmF0ZVNjaGVtYShtb2NrSnNvbkRhdGEsIHtcclxuICAgICAgICAgICAgICAgIGZvcm1hdDogJ2RyYWZ0LTA3JyxcclxuICAgICAgICAgICAgICAgIGluY2x1ZGVFeGFtcGxlczogdHJ1ZSxcclxuICAgICAgICAgICAgICAgIGluY2x1ZGVEZXNjcmlwdGlvbnM6IHRydWVcclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICBleHBlY3Qoc2NoZW1hKS50b0JlRGVmaW5lZCgpO1xyXG4gICAgICAgICAgICBjb25zdCBwYXJzZWRTY2hlbWEgPSBKU09OLnBhcnNlKHNjaGVtYSk7XHJcbiAgICAgICAgICAgIGV4cGVjdChwYXJzZWRTY2hlbWEuJHNjaGVtYSkudG9CZSgnaHR0cDovL2pzb24tc2NoZW1hLm9yZy9kcmFmdC0wNy9zY2hlbWEjJyk7XHJcbiAgICAgICAgICAgIGV4cGVjdChwYXJzZWRTY2hlbWEucHJvcGVydGllcykudG9CZURlZmluZWQoKTtcclxuICAgICAgICAgICAgZXhwZWN0KHBhcnNlZFNjaGVtYS5wcm9wZXJ0aWVzLnVzZXIpLnRvQmVEZWZpbmVkKCk7XHJcbiAgICAgICAgICAgIGV4cGVjdChwYXJzZWRTY2hlbWEucHJvcGVydGllcy5zZXR0aW5ncykudG9CZURlZmluZWQoKTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgaXQoJ3Nob3VsZCBmYWxsIGJhY2sgdG8gdHJhZGl0aW9uYWwgZ2VuZXJhdGlvbiB3aGVuIEFJIGlzIGRpc2FibGVkJywgYXN5bmMgKCkgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCB3b3JrZmxvdyA9IGpzb24uY3JlYXRlV29ya2Zsb3coe1xyXG4gICAgICAgICAgICAgICAgc2NoZW1hOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgdXNlQUk6IGZhbHNlXHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgY29uc3Qgc2NoZW1hID0gYXdhaXQgd29ya2Zsb3cuZ2VuZXJhdGVTY2hlbWEobW9ja0pzb25EYXRhKTtcclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIGV4cGVjdChzY2hlbWEpLnRvQmVEZWZpbmVkKCk7XHJcbiAgICAgICAgICAgIGNvbnN0IHBhcnNlZFNjaGVtYSA9IEpTT04ucGFyc2Uoc2NoZW1hKTtcclxuICAgICAgICAgICAgZXhwZWN0KHBhcnNlZFNjaGVtYS50eXBlKS50b0JlKCdvYmplY3QnKTtcclxuICAgICAgICAgICAgZXhwZWN0KHBhcnNlZFNjaGVtYS5wcm9wZXJ0aWVzKS50b0JlRGVmaW5lZCgpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfSk7XHJcblxyXG4gICAgZGVzY3JpYmUoJ1NjaGVtYSBHZW5lcmF0b3IgRmVhdHVyZXMnLCAoKSA9PiB7XHJcbiAgICAgICAgbGV0IGdlbmVyYXRvcjogU2NoZW1hR2VuZXJhdG9yO1xyXG5cclxuICAgICAgICBiZWZvcmVFYWNoKCgpID0+IHtcclxuICAgICAgICAgICAgZ2VuZXJhdG9yID0ganNvbi5jcmVhdGVTY2hlbWFHZW5lcmF0b3Ioe1xyXG4gICAgICAgICAgICAgICAgdXNlQUk6IHRydWUsXHJcbiAgICAgICAgICAgICAgICBkZWVwc2VlazogbW9ja0NvbmZpZ1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgaXQoJ3Nob3VsZCBnZW5lcmF0ZSBzY2hlbWEgd2l0aCBleGFtcGxlcycsIGFzeW5jICgpID0+IHtcclxuICAgICAgICAgICAgY29uc3Qgc2NoZW1hID0gYXdhaXQgZ2VuZXJhdG9yLmdlbmVyYXRlU2NoZW1hKG1vY2tKc29uRGF0YSwge1xyXG4gICAgICAgICAgICAgICAgaW5jbHVkZUV4YW1wbGVzOiB0cnVlXHJcbiAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgY29uc3QgcGFyc2VkU2NoZW1hID0gSlNPTi5wYXJzZShzY2hlbWEpO1xyXG4gICAgICAgICAgICBleHBlY3QocGFyc2VkU2NoZW1hLmV4YW1wbGVzKS50b0JlRGVmaW5lZCgpO1xyXG4gICAgICAgICAgICAvLyDpqozor4HnpLrkvovlgLznmoTnu5PmnoRcclxuICAgICAgICAgICAgaWYgKHBhcnNlZFNjaGVtYS5leGFtcGxlcyAmJiBwYXJzZWRTY2hlbWEuZXhhbXBsZXMubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgZXhhbXBsZSA9IHBhcnNlZFNjaGVtYS5leGFtcGxlc1swXTtcclxuICAgICAgICAgICAgICAgIGV4cGVjdChleGFtcGxlLnVzZXIpLnRvQmVEZWZpbmVkKCk7XHJcbiAgICAgICAgICAgICAgICBleHBlY3QoZXhhbXBsZS5zZXR0aW5ncykudG9CZURlZmluZWQoKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBpdCgnc2hvdWxkIGdlbmVyYXRlIHNjaGVtYSB3aXRoIGRlc2NyaXB0aW9ucycsIGFzeW5jICgpID0+IHtcclxuICAgICAgICAgICAgY29uc3Qgc2NoZW1hID0gYXdhaXQgZ2VuZXJhdG9yLmdlbmVyYXRlU2NoZW1hKG1vY2tKc29uRGF0YSwge1xyXG4gICAgICAgICAgICAgICAgaW5jbHVkZURlc2NyaXB0aW9uczogdHJ1ZVxyXG4gICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgIGNvbnN0IHBhcnNlZFNjaGVtYSA9IEpTT04ucGFyc2Uoc2NoZW1hKTtcclxuICAgICAgICAgICAgLy8g6aqM6K+B5o+P6L+w5a2X5q61XHJcbiAgICAgICAgICAgIGV4cGVjdChwYXJzZWRTY2hlbWEucHJvcGVydGllcy51c2VyLmRlc2NyaXB0aW9uKS50b0JlRGVmaW5lZCgpO1xyXG4gICAgICAgICAgICBleHBlY3QocGFyc2VkU2NoZW1hLnByb3BlcnRpZXMuc2V0dGluZ3MuZGVzY3JpcHRpb24pLnRvQmVEZWZpbmVkKCk7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIGl0KCdzaG91bGQgaGFuZGxlIGNvbXBsZXggbmVzdGVkIG9iamVjdHMnLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IGNvbXBsZXhEYXRhID0ge1xyXG4gICAgICAgICAgICAgICAgZGF0YToge1xyXG4gICAgICAgICAgICAgICAgICAgIGl0ZW1zOiBbXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHsgaWQ6IDEsIHZhbHVlOiAndGVzdCcgfSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgeyBpZDogMiwgdmFsdWU6ICd0ZXN0MicgfVxyXG4gICAgICAgICAgICAgICAgICAgIF0sXHJcbiAgICAgICAgICAgICAgICAgICAgbWV0YWRhdGE6IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY3JlYXRlZDogJzIwMjUtMDEtMTZUMTQ6MzQ6MDgrMDg6MDAnLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB0YWdzOiBbJ3RhZzEnLCAndGFnMiddXHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9O1xyXG5cclxuICAgICAgICAgICAgY29uc3Qgc2NoZW1hID0gYXdhaXQgZ2VuZXJhdG9yLmdlbmVyYXRlU2NoZW1hKGNvbXBsZXhEYXRhKTtcclxuICAgICAgICAgICAgY29uc3QgcGFyc2VkU2NoZW1hID0gSlNPTi5wYXJzZShzY2hlbWEpO1xyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgZXhwZWN0KHBhcnNlZFNjaGVtYS5wcm9wZXJ0aWVzLmRhdGEpLnRvQmVEZWZpbmVkKCk7XHJcbiAgICAgICAgICAgIGV4cGVjdChwYXJzZWRTY2hlbWEucHJvcGVydGllcy5kYXRhLnByb3BlcnRpZXMuaXRlbXMpLnRvQmVEZWZpbmVkKCk7XHJcbiAgICAgICAgICAgIGV4cGVjdChwYXJzZWRTY2hlbWEucHJvcGVydGllcy5kYXRhLnByb3BlcnRpZXMubWV0YWRhdGEpLnRvQmVEZWZpbmVkKCk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9KTtcclxuXHJcbiAgICBkZXNjcmliZSgnRGVlcFNlZWsgU2VydmljZSBJbnRlZ3JhdGlvbicsICgpID0+IHtcclxuICAgICAgICBsZXQgc2VydmljZTogRGVlcFNlZWtTZXJ2aWNlO1xyXG5cclxuICAgICAgICBiZWZvcmVFYWNoKCgpID0+IHtcclxuICAgICAgICAgICAgc2VydmljZSA9IG5ldyBEZWVwU2Vla1NlcnZpY2UobW9ja0NvbmZpZyk7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIGl0KCdzaG91bGQgZ2VuZXJhdGUgZmllbGQgZGVzY3JpcHRpb25zJywgYXN5bmMgKCkgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCBkZXNjcmlwdGlvbnMgPSBhd2FpdCBzZXJ2aWNlLmdlbmVyYXRlRmllbGREZXNjcmlwdGlvbnMobW9ja0pzb25EYXRhKTtcclxuICAgICAgICAgICAgZXhwZWN0KGRlc2NyaXB0aW9ucykudG9CZURlZmluZWQoKTtcclxuICAgICAgICAgICAgZXhwZWN0KGRlc2NyaXB0aW9uc1sndXNlci5uYW1lJ10pLnRvQmVEZWZpbmVkKCk7XHJcbiAgICAgICAgICAgIGV4cGVjdChkZXNjcmlwdGlvbnNbJ3VzZXIuZW1haWwnXSkudG9CZURlZmluZWQoKTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgaXQoJ3Nob3VsZCBnZW5lcmF0ZSBleGFtcGxlcycsIGFzeW5jICgpID0+IHtcclxuICAgICAgICAgICAgY29uc3Qgc2NoZW1hID0gYXdhaXQgc2VydmljZS5nZW5lcmF0ZVNjaGVtYShtb2NrSnNvbkRhdGEpO1xyXG4gICAgICAgICAgICBjb25zdCBleGFtcGxlcyA9IGF3YWl0IHNlcnZpY2UuZ2VuZXJhdGVFeGFtcGxlcyhzY2hlbWEpO1xyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgZXhwZWN0KGV4YW1wbGVzKS50b0JlRGVmaW5lZCgpO1xyXG4gICAgICAgICAgICBleHBlY3QoZXhhbXBsZXMudXNlcikudG9CZURlZmluZWQoKTtcclxuICAgICAgICAgICAgZXhwZWN0KGV4YW1wbGVzLnNldHRpbmdzKS50b0JlRGVmaW5lZCgpO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBpdCgnc2hvdWxkIGhhbmRsZSBlcnJvcnMgZ3JhY2VmdWxseScsIGFzeW5jICgpID0+IHtcclxuICAgICAgICAgICAgY29uc3QgaW52YWxpZEpzb24gPSAne2ludmFsaWQganNvbn0nO1xyXG4gICAgICAgICAgICBhd2FpdCBleHBlY3Qoc2VydmljZS5nZW5lcmF0ZVNjaGVtYShpbnZhbGlkSnNvbikpXHJcbiAgICAgICAgICAgICAgICAucmVqZWN0cy50b1Rocm93KCk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9KTtcclxuXHJcbiAgICBkZXNjcmliZSgnQ2FjaGluZyBCZWhhdmlvcicsICgpID0+IHtcclxuICAgICAgICBpdCgnc2hvdWxkIGNhY2hlIHNjaGVtYSBnZW5lcmF0aW9uIHJlc3VsdHMnLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IGdlbmVyYXRvciA9IGpzb24uY3JlYXRlU2NoZW1hR2VuZXJhdG9yKHtcclxuICAgICAgICAgICAgICAgIHVzZUFJOiB0cnVlLFxyXG4gICAgICAgICAgICAgICAgZGVlcHNlZWs6IG1vY2tDb25maWcsXHJcbiAgICAgICAgICAgICAgICBjYWNoaW5nOiB0cnVlXHJcbiAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgLy8g56ys5LiA5qyh55Sf5oiQXHJcbiAgICAgICAgICAgIGNvbnN0IHNjaGVtYTEgPSBhd2FpdCBnZW5lcmF0b3IuZ2VuZXJhdGVTY2hlbWEobW9ja0pzb25EYXRhKTtcclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIC8vIOesrOS6jOasoeeUn+aIkO+8iOW6lOivpeS9v+eUqOe8k+WtmO+8iVxyXG4gICAgICAgICAgICBjb25zdCBzY2hlbWEyID0gYXdhaXQgZ2VuZXJhdG9yLmdlbmVyYXRlU2NoZW1hKG1vY2tKc29uRGF0YSk7XHJcblxyXG4gICAgICAgICAgICBleHBlY3Qoc2NoZW1hMSkudG9CZShzY2hlbWEyKTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgaXQoJ3Nob3VsZCByZXNwZWN0IGNhY2hlIHNldHRpbmdzJywgYXN5bmMgKCkgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCBnZW5lcmF0b3IgPSBqc29uLmNyZWF0ZVNjaGVtYUdlbmVyYXRvcih7XHJcbiAgICAgICAgICAgICAgICB1c2VBSTogdHJ1ZSxcclxuICAgICAgICAgICAgICAgIGRlZXBzZWVrOiBtb2NrQ29uZmlnLFxyXG4gICAgICAgICAgICAgICAgY2FjaGluZzogZmFsc2VcclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICAvLyDnpoHnlKjnvJPlrZjml7bvvIzmr4/mrKHnlJ/miJDnmoQgU2NoZW1hIOWPr+iDveeVpeacieS4jeWQjFxyXG4gICAgICAgICAgICBjb25zdCBzY2hlbWExID0gYXdhaXQgZ2VuZXJhdG9yLmdlbmVyYXRlU2NoZW1hKG1vY2tKc29uRGF0YSk7XHJcbiAgICAgICAgICAgIGNvbnN0IHNjaGVtYTIgPSBhd2FpdCBnZW5lcmF0b3IuZ2VuZXJhdGVTY2hlbWEobW9ja0pzb25EYXRhKTtcclxuXHJcbiAgICAgICAgICAgIC8vIOeUseS6jiBBSSDnlJ/miJDnmoTlhoXlrrnlj6/og73nlaXmnInlt67lvILvvIzmiJHku6zlj6rmr5TovoPln7rmnKznu5PmnoRcclxuICAgICAgICAgICAgY29uc3QgcGFyc2VkMSA9IEpTT04ucGFyc2Uoc2NoZW1hMSk7XHJcbiAgICAgICAgICAgIGNvbnN0IHBhcnNlZDIgPSBKU09OLnBhcnNlKHNjaGVtYTIpO1xyXG4gICAgICAgICAgICBleHBlY3QocGFyc2VkMS4kc2NoZW1hKS50b0JlKHBhcnNlZDIuJHNjaGVtYSk7XHJcbiAgICAgICAgICAgIGV4cGVjdChPYmplY3Qua2V5cyhwYXJzZWQxLnByb3BlcnRpZXMpKS50b0VxdWFsKFxyXG4gICAgICAgICAgICAgICAgT2JqZWN0LmtleXMocGFyc2VkMi5wcm9wZXJ0aWVzKVxyXG4gICAgICAgICAgICApO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfSk7XHJcbn0pO1xyXG4iXSwidmVyc2lvbiI6M30=