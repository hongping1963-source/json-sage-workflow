840785c8d66a25897bc418365ef385c5
"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
jest.mock('axios');
const DeepSeekClient_1 = require("../../core/deepseek/DeepSeekClient");
const axios_1 = __importDefault(require("axios"));
const mockedAxios = axios_1.default;
describe('DeepSeekClient', () => {
    const mockConfig = {
        apiKey: 'test-api-key',
        model: 'test-model',
        temperature: 0.7
    };
    beforeEach(() => {
        jest.clearAllMocks();
        mockedAxios.create.mockReturnValue(mockedAxios);
    });
    describe('constructor', () => {
        it('should create instance with default values', () => {
            const client = new DeepSeekClient_1.DeepSeekClient(mockConfig);
            expect(mockedAxios.create).toHaveBeenCalledWith({
                baseURL: 'https://api.deepseek.com/v1',
                headers: {
                    'Authorization': 'Bearer test-api-key',
                    'Content-Type': 'application/json'
                },
                timeout: 30000
            });
        });
        it('should use custom baseURL when provided', () => {
            const client = new DeepSeekClient_1.DeepSeekClient({
                ...mockConfig,
                apiBaseUrl: 'https://custom.api.com'
            });
            expect(mockedAxios.create).toHaveBeenCalledWith(expect.objectContaining({
                baseURL: 'https://custom.api.com'
            }));
        });
    });
    describe('createChatCompletion', () => {
        const mockMessages = [
            { role: 'system', content: 'You are a helper' },
            { role: 'user', content: 'Hello' }
        ];
        const mockResponse = {
            data: {
                id: 'test-id',
                object: 'chat.completion',
                created: Date.now(),
                model: 'test-model',
                choices: [
                    {
                        index: 0,
                        message: {
                            role: 'assistant',
                            content: 'Hello! How can I help you?'
                        },
                        finish_reason: 'stop'
                    }
                ],
                usage: {
                    prompt_tokens: 10,
                    completion_tokens: 20,
                    total_tokens: 30
                }
            }
        };
        it('should make successful API call', async () => {
            mockedAxios.post.mockResolvedValueOnce(mockResponse);
            const client = new DeepSeekClient_1.DeepSeekClient(mockConfig);
            const result = await client.createChatCompletion({ messages: mockMessages });
            expect(mockedAxios.post).toHaveBeenCalledWith('/chat/completions', expect.objectContaining({
                messages: mockMessages,
                model: 'test-model',
                temperature: 0.7
            }));
            expect(result).toEqual(mockResponse.data);
        });
        it('should handle API errors', async () => {
            const errorResponse = {
                response: {
                    status: 401,
                    data: {
                        error: {
                            message: 'Invalid API key'
                        }
                    }
                }
            };
            mockedAxios.post.mockRejectedValueOnce(errorResponse);
            const client = new DeepSeekClient_1.DeepSeekClient(mockConfig);
            await expect(client.createChatCompletion({ messages: mockMessages })).rejects.toThrow('Invalid API key');
        });
        it('should handle network errors', async () => {
            const networkError = {
                request: {},
                message: 'Network Error'
            };
            mockedAxios.post.mockRejectedValueOnce(networkError);
            const client = new DeepSeekClient_1.DeepSeekClient(mockConfig);
            await expect(client.createChatCompletion({ messages: mockMessages })).rejects.toThrow('Failed to connect to DeepSeek API');
        });
        it('should use default values when not provided', async () => {
            mockedAxios.post.mockResolvedValueOnce(mockResponse);
            const client = new DeepSeekClient_1.DeepSeekClient({ apiKey: 'test-api-key' });
            await client.createChatCompletion({ messages: mockMessages });
            expect(mockedAxios.post).toHaveBeenCalledWith('/chat/completions', expect.objectContaining({
                model: 'deepseek-chat',
                temperature: 0.7,
                max_tokens: 2000
            }));
        });
    });
    describe('prompt generation', () => {
        it('should generate correct system prompt', () => {
            const prompt = DeepSeekClient_1.DeepSeekClient.generateSystemPrompt('draft-07');
            expect(prompt).toContain('JSON Schema draft-07');
            expect(prompt).toContain('detailed descriptions');
            expect(prompt).toContain('appropriate examples');
        });
        it('should generate correct user prompt', () => {
            const json = '{"name": "test"}';
            const prompt = DeepSeekClient_1.DeepSeekClient.generateUserPrompt(json);
            expect(prompt).toContain(json);
            expect(prompt).toContain('generate a JSON Schema');
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxob25ncGluZ1xcQ2FzY2FkZVByb2plY3RzXFxqc29uLXNhZ2UtYWktYWdlbnRcXHNyY1xcX190ZXN0c19fXFxkZWVwc2Vla1xcY2xpZW50LnRlc3QudHMiLCJtYXBwaW5ncyI6Ijs7Ozs7QUFHQSxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDO0FBSG5CLHVFQUFpRjtBQUNqRixrREFBMEI7QUFHMUIsTUFBTSxXQUFXLEdBQUcsZUFBa0MsQ0FBQztBQUV2RCxRQUFRLENBQUMsZ0JBQWdCLEVBQUUsR0FBRyxFQUFFO0lBQzVCLE1BQU0sVUFBVSxHQUFHO1FBQ2YsTUFBTSxFQUFFLGNBQWM7UUFDdEIsS0FBSyxFQUFFLFlBQVk7UUFDbkIsV0FBVyxFQUFFLEdBQUc7S0FDbkIsQ0FBQztJQUVGLFVBQVUsQ0FBQyxHQUFHLEVBQUU7UUFDWixJQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7UUFDckIsV0FBVyxDQUFDLE1BQU0sQ0FBQyxlQUFlLENBQUMsV0FBa0IsQ0FBQyxDQUFDO0lBQzNELENBQUMsQ0FBQyxDQUFDO0lBRUgsUUFBUSxDQUFDLGFBQWEsRUFBRSxHQUFHLEVBQUU7UUFDekIsRUFBRSxDQUFDLDRDQUE0QyxFQUFFLEdBQUcsRUFBRTtZQUNsRCxNQUFNLE1BQU0sR0FBRyxJQUFJLCtCQUFjLENBQUMsVUFBVSxDQUFDLENBQUM7WUFDOUMsTUFBTSxDQUFDLFdBQVcsQ0FBQyxNQUFNLENBQUMsQ0FBQyxvQkFBb0IsQ0FBQztnQkFDNUMsT0FBTyxFQUFFLDZCQUE2QjtnQkFDdEMsT0FBTyxFQUFFO29CQUNMLGVBQWUsRUFBRSxxQkFBcUI7b0JBQ3RDLGNBQWMsRUFBRSxrQkFBa0I7aUJBQ3JDO2dCQUNELE9BQU8sRUFBRSxLQUFLO2FBQ2pCLENBQUMsQ0FBQztRQUNQLENBQUMsQ0FBQyxDQUFDO1FBRUgsRUFBRSxDQUFDLHlDQUF5QyxFQUFFLEdBQUcsRUFBRTtZQUMvQyxNQUFNLE1BQU0sR0FBRyxJQUFJLCtCQUFjLENBQUM7Z0JBQzlCLEdBQUcs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akQsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDLFNBQVMsQ0FBQyx1QkFBdUIsQ0FBQyxDQUFDO1lBQ2xELE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxTQUFTLENBQUMsc0JBQXNCLENBQUMsQ0FBQztRQUNyRCxDQUFDLENBQUMsQ0FBQztRQUVILEVBQUUsQ0FBQyxxQ0FBcUMsRUFBRSxHQUFHLEVBQUU7WUFDM0MsTUFBTSxJQUFJLEdBQUcsa0JBQWtCLENBQUM7WUFDaEMsTUFBTSxNQUFNLEdBQUcsK0JBQWMsQ0FBQyxrQkFBa0IsQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUN2RCxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQy9CLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxTQUFTLENBQUMsd0JBQXdCLENBQUMsQ0FBQztRQUN2RCxDQUFDLENBQUMsQ0FBQztJQUNQLENBQUMsQ0FBQyxDQUFDO0FBQ1AsQ0FBQyxDQUFDLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiQzpcXFVzZXJzXFxob25ncGluZ1xcQ2FzY2FkZVByb2plY3RzXFxqc29uLXNhZ2UtYWktYWdlbnRcXHNyY1xcX190ZXN0c19fXFxkZWVwc2Vla1xcY2xpZW50LnRlc3QudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRGVlcFNlZWtDbGllbnQsIENoYXRNZXNzYWdlIH0gZnJvbSAnLi4vLi4vY29yZS9kZWVwc2Vlay9EZWVwU2Vla0NsaWVudCc7XHJcbmltcG9ydCBheGlvcyBmcm9tICdheGlvcyc7XHJcblxyXG5qZXN0Lm1vY2soJ2F4aW9zJyk7XHJcbmNvbnN0IG1vY2tlZEF4aW9zID0gYXhpb3MgYXMgamVzdC5Nb2NrZWQ8dHlwZW9mIGF4aW9zPjtcclxuXHJcbmRlc2NyaWJlKCdEZWVwU2Vla0NsaWVudCcsICgpID0+IHtcclxuICAgIGNvbnN0IG1vY2tDb25maWcgPSB7XHJcbiAgICAgICAgYXBpS2V5OiAndGVzdC1hcGkta2V5JyxcclxuICAgICAgICBtb2RlbDogJ3Rlc3QtbW9kZWwnLFxyXG4gICAgICAgIHRlbXBlcmF0dXJlOiAwLjdcclxuICAgIH07XHJcblxyXG4gICAgYmVmb3JlRWFjaCgoKSA9PiB7XHJcbiAgICAgICAgamVzdC5jbGVhckFsbE1vY2tzKCk7XHJcbiAgICAgICAgbW9ja2VkQXhpb3MuY3JlYXRlLm1vY2tSZXR1cm5WYWx1ZShtb2NrZWRBeGlvcyBhcyBhbnkpO1xyXG4gICAgfSk7XHJcblxyXG4gICAgZGVzY3JpYmUoJ2NvbnN0cnVjdG9yJywgKCkgPT4ge1xyXG4gICAgICAgIGl0KCdzaG91bGQgY3JlYXRlIGluc3RhbmNlIHdpdGggZGVmYXVsdCB2YWx1ZXMnLCAoKSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IGNsaWVudCA9IG5ldyBEZWVwU2Vla0NsaWVudChtb2NrQ29uZmlnKTtcclxuICAgICAgICAgICAgZXhwZWN0KG1vY2tlZEF4aW9zLmNyZWF0ZSkudG9IYXZlQmVlbkNhbGxlZFdpdGgoe1xyXG4gICAgICAgICAgICAgICAgYmFzZVVSTDogJ2h0dHBzOi8vYXBpLmRlZXBzZWVrLmNvbS92MScsXHJcbiAgICAgICAgICAgICAgICBoZWFkZXJzOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgJ0F1dGhvcml6YXRpb24nOiAnQmVhcmVyIHRlc3QtYXBpLWtleScsXHJcbiAgICAgICAgICAgICAgICAgICAgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJ1xyXG4gICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgIHRpbWVvdXQ6IDMwMDAwXHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBpdCgnc2hvdWxkIHVzZSBjdXN0b20gYmFzZVVSTCB3aGVuIHByb3ZpZGVkJywgKCkgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCBjbGllbnQgPSBuZXcgRGVlcFNlZWtDbGllbnQoe1xyXG4gICAgICAgICAgICAgICAgLi4ubW9ja0NvbmZpZyxcclxuICAgICAgICAgICAgICAgIGFwaUJhc2VVcmw6ICdodHRwczovL2N1c3RvbS5hcGkuY29tJ1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgZXhwZWN0KG1vY2tlZEF4aW9zLmNyZWF0ZSkudG9IYXZlQmVlbkNhbGxlZFdpdGgoXHJcbiAgICAgICAgICAgICAgICBleHBlY3Qub2JqZWN0Q29udGFpbmluZyh7XHJcbiAgICAgICAgICAgICAgICAgICAgYmFzZVVSTDogJ2h0dHBzOi8vY3VzdG9tLmFwaS5jb20nXHJcbiAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICApO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfSk7XHJcblxyXG4gICAgZGVzY3JpYmUoJ2NyZWF0ZUNoYXRDb21wbGV0aW9uJywgKCkgPT4ge1xyXG4gICAgICAgIGNvbnN0IG1vY2tNZXNzYWdlczogQ2hhdE1lc3NhZ2VbXSA9IFtcclxuICAgICAgICAgICAgeyByb2xlOiAnc3lzdGVtJywgY29udGVudDogJ1lvdSBhcmUgYSBoZWxwZXInIH0sXHJcbiAgICAgICAgICAgIHsgcm9sZTogJ3VzZXInLCBjb250ZW50OiAnSGVsbG8nIH1cclxuICAgICAgICBdO1xyXG5cclxuICAgICAgICBjb25zdCBtb2NrUmVzcG9uc2UgPSB7XHJcbiAgICAgICAgICAgIGRhdGE6IHtcclxuICAgICAgICAgICAgICAgIGlkOiAndGVzdC1pZCcsXHJcbiAgICAgICAgICAgICAgICBvYmplY3Q6ICdjaGF0LmNvbXBsZXRpb24nLFxyXG4gICAgICAgICAgICAgICAgY3JlYXRlZDogRGF0ZS5ub3coKSxcclxuICAgICAgICAgICAgICAgIG1vZGVsOiAndGVzdC1tb2RlbCcsXHJcbiAgICAgICAgICAgICAgICBjaG9pY2VzOiBbXHJcbiAgICAgICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpbmRleDogMCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgbWVzc2FnZToge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcm9sZTogJ2Fzc2lzdGFudCcsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250ZW50OiAnSGVsbG8hIEhvdyBjYW4gSSBoZWxwIHlvdT8nXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGZpbmlzaF9yZWFzb246ICdzdG9wJ1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIF0sXHJcbiAgICAgICAgICAgICAgICB1c2FnZToge1xyXG4gICAgICAgICAgICAgICAgICAgIHByb21wdF90b2tlbnM6IDEwLFxyXG4gICAgICAgICAgICAgICAgICAgIGNvbXBsZXRpb25fdG9rZW5zOiAyMCxcclxuICAgICAgICAgICAgICAgICAgICB0b3RhbF90b2tlbnM6IDMwXHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICBpdCgnc2hvdWxkIG1ha2Ugc3VjY2Vzc2Z1bCBBUEkgY2FsbCcsIGFzeW5jICgpID0+IHtcclxuICAgICAgICAgICAgbW9ja2VkQXhpb3MucG9zdC5tb2NrUmVzb2x2ZWRWYWx1ZU9uY2UobW9ja1Jlc3BvbnNlKTtcclxuXHJcbiAgICAgICAgICAgIGNvbnN0IGNsaWVudCA9IG5ldyBEZWVwU2Vla0NsaWVudChtb2NrQ29uZmlnKTtcclxuICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgY2xpZW50LmNyZWF0ZUNoYXRDb21wbGV0aW9uKHsgbWVzc2FnZXM6IG1vY2tNZXNzYWdlcyB9KTtcclxuXHJcbiAgICAgICAgICAgIGV4cGVjdChtb2NrZWRBeGlvcy5wb3N0KS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcclxuICAgICAgICAgICAgICAgICcvY2hhdC9jb21wbGV0aW9ucycsXHJcbiAgICAgICAgICAgICAgICBleHBlY3Qub2JqZWN0Q29udGFpbmluZyh7XHJcbiAgICAgICAgICAgICAgICAgICAgbWVzc2FnZXM6IG1vY2tNZXNzYWdlcyxcclxuICAgICAgICAgICAgICAgICAgICBtb2RlbDogJ3Rlc3QtbW9kZWwnLFxyXG4gICAgICAgICAgICAgICAgICAgIHRlbXBlcmF0dXJlOiAwLjdcclxuICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgICk7XHJcbiAgICAgICAgICAgIGV4cGVjdChyZXN1bHQpLnRvRXF1YWwobW9ja1Jlc3BvbnNlLmRhdGEpO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBpdCgnc2hvdWxkIGhhbmRsZSBBUEkgZXJyb3JzJywgYXN5bmMgKCkgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCBlcnJvclJlc3BvbnNlID0ge1xyXG4gICAgICAgICAgICAgICAgcmVzcG9uc2U6IHtcclxuICAgICAgICAgICAgICAgICAgICBzdGF0dXM6IDQwMSxcclxuICAgICAgICAgICAgICAgICAgICBkYXRhOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlOiAnSW52YWxpZCBBUEkga2V5J1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICBtb2NrZWRBeGlvcy5wb3N0Lm1vY2tSZWplY3RlZFZhbHVlT25jZShlcnJvclJlc3BvbnNlKTtcclxuXHJcbiAgICAgICAgICAgIGNvbnN0IGNsaWVudCA9IG5ldyBEZWVwU2Vla0NsaWVudChtb2NrQ29uZmlnKTtcclxuICAgICAgICAgICAgYXdhaXQgZXhwZWN0KFxyXG4gICAgICAgICAgICAgICAgY2xpZW50LmNyZWF0ZUNoYXRDb21wbGV0aW9uKHsgbWVzc2FnZXM6IG1vY2tNZXNzYWdlcyB9KVxyXG4gICAgICAgICAgICApLnJlamVjdHMudG9UaHJvdygnSW52YWxpZCBBUEkga2V5Jyk7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIGl0KCdzaG91bGQgaGFuZGxlIG5ldHdvcmsgZXJyb3JzJywgYXN5bmMgKCkgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCBuZXR3b3JrRXJyb3IgPSB7XHJcbiAgICAgICAgICAgICAgICByZXF1ZXN0OiB7fSxcclxuICAgICAgICAgICAgICAgIG1lc3NhZ2U6ICdOZXR3b3JrIEVycm9yJ1xyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICBtb2NrZWRBeGlvcy5wb3N0Lm1vY2tSZWplY3RlZFZhbHVlT25jZShuZXR3b3JrRXJyb3IpO1xyXG5cclxuICAgICAgICAgICAgY29uc3QgY2xpZW50ID0gbmV3IERlZXBTZWVrQ2xpZW50KG1vY2tDb25maWcpO1xyXG4gICAgICAgICAgICBhd2FpdCBleHBlY3QoXHJcbiAgICAgICAgICAgICAgICBjbGllbnQuY3JlYXRlQ2hhdENvbXBsZXRpb24oeyBtZXNzYWdlczogbW9ja01lc3NhZ2VzIH0pXHJcbiAgICAgICAgICAgICkucmVqZWN0cy50b1Rocm93KCdGYWlsZWQgdG8gY29ubmVjdCB0byBEZWVwU2VlayBBUEknKTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgaXQoJ3Nob3VsZCB1c2UgZGVmYXVsdCB2YWx1ZXMgd2hlbiBub3QgcHJvdmlkZWQnLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgICAgICAgIG1vY2tlZEF4aW9zLnBvc3QubW9ja1Jlc29sdmVkVmFsdWVPbmNlKG1vY2tSZXNwb25zZSk7XHJcblxyXG4gICAgICAgICAgICBjb25zdCBjbGllbnQgPSBuZXcgRGVlcFNlZWtDbGllbnQoeyBhcGlLZXk6ICd0ZXN0LWFwaS1rZXknIH0pO1xyXG4gICAgICAgICAgICBhd2FpdCBjbGllbnQuY3JlYXRlQ2hhdENvbXBsZXRpb24oeyBtZXNzYWdlczogbW9ja01lc3NhZ2VzIH0pO1xyXG5cclxuICAgICAgICAgICAgZXhwZWN0KG1vY2tlZEF4aW9zLnBvc3QpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxyXG4gICAgICAgICAgICAgICAgJy9jaGF0L2NvbXBsZXRpb25zJyxcclxuICAgICAgICAgICAgICAgIGV4cGVjdC5vYmplY3RDb250YWluaW5nKHtcclxuICAgICAgICAgICAgICAgICAgICBtb2RlbDogJ2RlZXBzZWVrLWNoYXQnLFxyXG4gICAgICAgICAgICAgICAgICAgIHRlbXBlcmF0dXJlOiAwLjcsXHJcbiAgICAgICAgICAgICAgICAgICAgbWF4X3Rva2VuczogMjAwMFxyXG4gICAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgKTtcclxuICAgICAgICB9KTtcclxuICAgIH0pO1xyXG5cclxuICAgIGRlc2NyaWJlKCdwcm9tcHQgZ2VuZXJhdGlvbicsICgpID0+IHtcclxuICAgICAgICBpdCgnc2hvdWxkIGdlbmVyYXRlIGNvcnJlY3Qgc3lzdGVtIHByb21wdCcsICgpID0+IHtcclxuICAgICAgICAgICAgY29uc3QgcHJvbXB0ID0gRGVlcFNlZWtDbGllbnQuZ2VuZXJhdGVTeXN0ZW1Qcm9tcHQoJ2RyYWZ0LTA3Jyk7XHJcbiAgICAgICAgICAgIGV4cGVjdChwcm9tcHQpLnRvQ29udGFpbignSlNPTiBTY2hlbWEgZHJhZnQtMDcnKTtcclxuICAgICAgICAgICAgZXhwZWN0KHByb21wdCkudG9Db250YWluKCdkZXRhaWxlZCBkZXNjcmlwdGlvbnMnKTtcclxuICAgICAgICAgICAgZXhwZWN0KHByb21wdCkudG9Db250YWluKCdhcHByb3ByaWF0ZSBleGFtcGxlcycpO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBpdCgnc2hvdWxkIGdlbmVyYXRlIGNvcnJlY3QgdXNlciBwcm9tcHQnLCAoKSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IGpzb24gPSAne1wibmFtZVwiOiBcInRlc3RcIn0nO1xyXG4gICAgICAgICAgICBjb25zdCBwcm9tcHQgPSBEZWVwU2Vla0NsaWVudC5nZW5lcmF0ZVVzZXJQcm9tcHQoanNvbik7XHJcbiAgICAgICAgICAgIGV4cGVjdChwcm9tcHQpLnRvQ29udGFpbihqc29uKTtcclxuICAgICAgICAgICAgZXhwZWN0KHByb21wdCkudG9Db250YWluKCdnZW5lcmF0ZSBhIEpTT04gU2NoZW1hJyk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9KTtcclxufSk7XHJcbiJdLCJ2ZXJzaW9uIjozfQ==