69e67835adbedd5f95d5f2e70806d177
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const cache_1 = require("../core/cache");
describe('SmartCache', () => {
    let cache;
    beforeEach(() => {
        cache = new cache_1.SmartCache({
            maxSize: 1000,
            ttl: 1000,
            smartPruning: true
        });
    });
    describe('Basic Operations', () => {
        it('should store and retrieve values', () => {
            const testData = { test: 'value' };
            cache.set('key1', testData);
            expect(cache.get('key1')).toEqual(testData);
        });
        it('should handle non-existent keys', () => {
            expect(cache.get('nonexistent')).toBeUndefined();
        });
        it('should handle undefined and null values', () => {
            cache.set('undefined', undefined);
            cache.set('null', null);
            expect(cache.get('undefined')).toBeUndefined();
            expect(cache.get('null')).toBeNull();
        });
    });
    describe('TTL Functionality', () => {
        it('should expire items after TTL', async () => {
            const testData = { test: 'value' };
            cache.set('expiring', testData);
            // Wait for TTL to expire
            await new Promise(resolve => setTimeout(resolve, 1100));
            expect(cache.get('expiring')).toBeUndefined();
        });
        it('should reset TTL on access', async () => {
            const testData = { test: 'value' };
            cache.set('accessed', testData);
            // Access the item just before expiration
            await new Promise(resolve => setTimeout(resolve, 900));
            expect(cache.get('accessed')).toEqual(testData);
            // Wait another 900ms (total 1800ms, more than original TTL)
            await new Promise(resolve => setTimeout(resolve, 900));
            expect(cache.get('accessed')).toEqual(testData);
        });
    });
    describe('Size Management', () => {
        it('should handle large items', () => {
            const largeData = { data: 'x'.repeat(2000) }; // Exceeds maxSize
            cache.set('large', largeData);
            expect(cache.get('large')).toBeUndefined();
        });
        it('should evict items when full', () => {
            // Fill cache to capacity
            for (let i = 0; i < 10; i++) {
                cache.set(`key${i}`, { data: 'x'.repeat(90) });
            }
            // Add one more item
            cache.set('newKey', { data: 'test' });
            // Some old items should be evicted
            let existingItems = 0;
            for (let i = 0; i < 10; i++) {
                if (cache.get(`key${i}`))
                    existingItems++;
            }
            expect(existingItems).toBeLessThan(10);
            expect(cache.get('newKey')).toBeDefined();
        });
    });
    describe('Smart Pruning', () => {
        it('should prefer keeping frequently accessed items', () => {
            // Add items
            for (let i = 0; i < 5; i++) {
                cache.set(`key${i}`, { data: 'x'.repeat(100) });
            }
            // Access some items frequently
            for (let i = 0; i < 10; i++) {
                cache.get('key0');
                cache.get('key1');
            }
            // Fill cache to force eviction
            for (let i = 5; i < 10; i++) {
                cache.set(`key${i}`, { data: 'x'.repeat(100) });
            }
            // Frequently accessed items should still be there
            expect(cache.get('key0')).toBeDefined();
            expect(cache.get('key1')).toBeDefined();
        });
    });
    describe('Statistics', () => {
        it('should track cache statistics', () => {
            cache.set('key1', 'value1');
            cache.get('key1');
            cache.get('key1');
            const stats = cache.getStats();
            expect(stats).toHaveProperty('totalSize');
            expect(stats).toHaveProperty('itemCount');
            expect(stats).toHaveProperty('utilization');
            expect(stats).toHaveProperty('averageAccessCount');
            expect(stats.itemCount).toBe(1);
            expect(stats.averageAccessCount).toBe(2);
        });
    });
    describe('Edge Cases', () => {
        it('should handle circular references', () => {
            const circular = { name: 'test' };
            circular.self = circular;
            expect(() => cache.set('circular', circular)).not.toThrow();
        });
        it('should handle various data types', () => {
            const testCases = [
                ['string', 'test string'],
                ['number', 123],
                ['boolean', true],
                ['array', [1, 2, 3]],
                ['date', new Date()],
                ['regexp', /test/],
                ['function', function () { return 'test'; }]
            ];
            testCases.forEach(([key, value]) => {
                cache.set(key, value);
                expect(cache.get(key)).toEqual(value);
            });
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxob25ncGluZ1xcQ2FzY2FkZVByb2plY3RzXFxqc29uLXNhZ2UtYWktYWdlbnRcXHNyY1xcX190ZXN0c19fXFxjYWNoZS50ZXN0LnRzIiwibWFwcGluZ3MiOiI7O0FBQUEseUNBQTJDO0FBRTNDLFFBQVEsQ0FBQyxZQUFZLEVBQUUsR0FBRyxFQUFFO0lBQ3hCLElBQUksS0FBc0IsQ0FBQztJQUUzQixVQUFVLENBQUMsR0FBRyxFQUFFO1FBQ1osS0FBSyxHQUFHLElBQUksa0JBQVUsQ0FBQztZQUNuQixPQUFPLEVBQUUsSUFBSTtZQUNiLEdBQUcsRUFBRSxJQUFJO1lBQ1QsWUFBWSxFQUFFLElBQUk7U0FDckIsQ0FBQyxDQUFDO0lBQ1AsQ0FBQyxDQUFDLENBQUM7SUFFSCxRQUFRLENBQUMsa0JBQWtCLEVBQUUsR0FBRyxFQUFFO1FBQzlCLEVBQUUsQ0FBQyxrQ0FBa0MsRUFBRSxHQUFHLEVBQUU7WUFDeEMsTUFBTSxRQUFRLEdBQUcsRUFBRSxJQUFJLEVBQUUsT0FBTyxFQUFFLENBQUM7WUFDbkMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxNQUFNLEVBQUUsUUFBUSxDQUFDLENBQUM7WUFDNUIsTUFBTSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDaEQsQ0FBQyxDQUFDLENBQUM7UUFFSCxFQUFFLENBQUMsaUNBQWlDLEVBQUUsR0FBRyxFQUFFO1lBQ3ZDLE1BQU0sQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLGFBQWEsQ0FBQyxDQUFDLENBQUMsYUFBYSxFQUFFLENBQUM7UUFDckQsQ0FBQyxDQUFDLENBQUM7UUFFSCxFQUFFLENBQUMseUNBQXlDLEVBQUUsR0FBRyxFQUFFO1lBQy9DLEtBQUssQ0FBQyxHQUFHLENBQUMsV0FBVyxFQUFFLFNBQVMsQ0FBQyxDQUFDO1lBQ2xDLEtBQUssQ0FBQyxHQUFHLENBQUMsTUFBTSxFQUFFLElBQUksQ0FBQyxDQUFDO1lBRXhCLE1BQU0sQ0FBQyxL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OlxcVXNlcnNcXGhvbmdwaW5nXFxDYXNjYWRlUHJvamVjdHNcXGpzb24tc2FnZS1haS1hZ2VudFxcc3JjXFxfX3Rlc3RzX19cXGNhY2hlLnRlc3QudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgU21hcnRDYWNoZSB9IGZyb20gJy4uL2NvcmUvY2FjaGUnO1xyXG5cclxuZGVzY3JpYmUoJ1NtYXJ0Q2FjaGUnLCAoKSA9PiB7XHJcbiAgICBsZXQgY2FjaGU6IFNtYXJ0Q2FjaGU8YW55PjtcclxuXHJcbiAgICBiZWZvcmVFYWNoKCgpID0+IHtcclxuICAgICAgICBjYWNoZSA9IG5ldyBTbWFydENhY2hlKHtcclxuICAgICAgICAgICAgbWF4U2l6ZTogMTAwMCxcclxuICAgICAgICAgICAgdHRsOiAxMDAwLCAvLyAxIHNlY29uZCBmb3IgdGVzdGluZ1xyXG4gICAgICAgICAgICBzbWFydFBydW5pbmc6IHRydWVcclxuICAgICAgICB9KTtcclxuICAgIH0pO1xyXG5cclxuICAgIGRlc2NyaWJlKCdCYXNpYyBPcGVyYXRpb25zJywgKCkgPT4ge1xyXG4gICAgICAgIGl0KCdzaG91bGQgc3RvcmUgYW5kIHJldHJpZXZlIHZhbHVlcycsICgpID0+IHtcclxuICAgICAgICAgICAgY29uc3QgdGVzdERhdGEgPSB7IHRlc3Q6ICd2YWx1ZScgfTtcclxuICAgICAgICAgICAgY2FjaGUuc2V0KCdrZXkxJywgdGVzdERhdGEpO1xyXG4gICAgICAgICAgICBleHBlY3QoY2FjaGUuZ2V0KCdrZXkxJykpLnRvRXF1YWwodGVzdERhdGEpO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBpdCgnc2hvdWxkIGhhbmRsZSBub24tZXhpc3RlbnQga2V5cycsICgpID0+IHtcclxuICAgICAgICAgICAgZXhwZWN0KGNhY2hlLmdldCgnbm9uZXhpc3RlbnQnKSkudG9CZVVuZGVmaW5lZCgpO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBpdCgnc2hvdWxkIGhhbmRsZSB1bmRlZmluZWQgYW5kIG51bGwgdmFsdWVzJywgKCkgPT4ge1xyXG4gICAgICAgICAgICBjYWNoZS5zZXQoJ3VuZGVmaW5lZCcsIHVuZGVmaW5lZCk7XHJcbiAgICAgICAgICAgIGNhY2hlLnNldCgnbnVsbCcsIG51bGwpO1xyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgZXhwZWN0KGNhY2hlLmdldCgndW5kZWZpbmVkJykpLnRvQmVVbmRlZmluZWQoKTtcclxuICAgICAgICAgICAgZXhwZWN0KGNhY2hlLmdldCgnbnVsbCcpKS50b0JlTnVsbCgpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfSk7XHJcblxyXG4gICAgZGVzY3JpYmUoJ1RUTCBGdW5jdGlvbmFsaXR5JywgKCkgPT4ge1xyXG4gICAgICAgIGl0KCdzaG91bGQgZXhwaXJlIGl0ZW1zIGFmdGVyIFRUTCcsIGFzeW5jICgpID0+IHtcclxuICAgICAgICAgICAgY29uc3QgdGVzdERhdGEgPSB7IHRlc3Q6ICd2YWx1ZScgfTtcclxuICAgICAgICAgICAgY2FjaGUuc2V0KCdleHBpcmluZycsIHRlc3REYXRhKTtcclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIC8vIFdhaXQgZm9yIFRUTCB0byBleHBpcmVcclxuICAgICAgICAgICAgYXdhaXQgbmV3IFByb21pc2UocmVzb2x2ZSA9PiBzZXRUaW1lb3V0KHJlc29sdmUsIDExMDApKTtcclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIGV4cGVjdChjYWNoZS5nZXQoJ2V4cGlyaW5nJykpLnRvQmVVbmRlZmluZWQoKTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgaXQoJ3Nob3VsZCByZXNldCBUVEwgb24gYWNjZXNzJywgYXN5bmMgKCkgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCB0ZXN0RGF0YSA9IHsgdGVzdDogJ3ZhbHVlJyB9O1xyXG4gICAgICAgICAgICBjYWNoZS5zZXQoJ2FjY2Vzc2VkJywgdGVzdERhdGEpO1xyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgLy8gQWNjZXNzIHRoZSBpdGVtIGp1c3QgYmVmb3JlIGV4cGlyYXRpb25cclxuICAgICAgICAgICAgYXdhaXQgbmV3IFByb21pc2UocmVzb2x2ZSA9PiBzZXRUaW1lb3V0KHJlc29sdmUsIDkwMCkpO1xyXG4gICAgICAgICAgICBleHBlY3QoY2FjaGUuZ2V0KCdhY2Nlc3NlZCcpKS50b0VxdWFsKHRlc3REYXRhKTtcclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIC8vIFdhaXQgYW5vdGhlciA5MDBtcyAodG90YWwgMTgwMG1zLCBtb3JlIHRoYW4gb3JpZ2luYWwgVFRMKVxyXG4gICAgICAgICAgICBhd2FpdCBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHNldFRpbWVvdXQocmVzb2x2ZSwgOTAwKSk7XHJcbiAgICAgICAgICAgIGV4cGVjdChjYWNoZS5nZXQoJ2FjY2Vzc2VkJykpLnRvRXF1YWwodGVzdERhdGEpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfSk7XHJcblxyXG4gICAgZGVzY3JpYmUoJ1NpemUgTWFuYWdlbWVudCcsICgpID0+IHtcclxuICAgICAgICBpdCgnc2hvdWxkIGhhbmRsZSBsYXJnZSBpdGVtcycsICgpID0+IHtcclxuICAgICAgICAgICAgY29uc3QgbGFyZ2VEYXRhID0geyBkYXRhOiAneCcucmVwZWF0KDIwMDApIH07IC8vIEV4Y2VlZHMgbWF4U2l6ZVxyXG4gICAgICAgICAgICBjYWNoZS5zZXQoJ2xhcmdlJywgbGFyZ2VEYXRhKTtcclxuICAgICAgICAgICAgZXhwZWN0KGNhY2hlLmdldCgnbGFyZ2UnKSkudG9CZVVuZGVmaW5lZCgpO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBpdCgnc2hvdWxkIGV2aWN0IGl0ZW1zIHdoZW4gZnVsbCcsICgpID0+IHtcclxuICAgICAgICAgICAgLy8gRmlsbCBjYWNoZSB0byBjYXBhY2l0eVxyXG4gICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IDEwOyBpKyspIHtcclxuICAgICAgICAgICAgICAgIGNhY2hlLnNldChga2V5JHtpfWAsIHsgZGF0YTogJ3gnLnJlcGVhdCg5MCkgfSk7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIC8vIEFkZCBvbmUgbW9yZSBpdGVtXHJcbiAgICAgICAgICAgIGNhY2hlLnNldCgnbmV3S2V5JywgeyBkYXRhOiAndGVzdCcgfSk7XHJcblxyXG4gICAgICAgICAgICAvLyBTb21lIG9sZCBpdGVtcyBzaG91bGQgYmUgZXZpY3RlZFxyXG4gICAgICAgICAgICBsZXQgZXhpc3RpbmdJdGVtcyA9IDA7XHJcbiAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgMTA7IGkrKykge1xyXG4gICAgICAgICAgICAgICAgaWYgKGNhY2hlLmdldChga2V5JHtpfWApKSBleGlzdGluZ0l0ZW1zKys7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGV4cGVjdChleGlzdGluZ0l0ZW1zKS50b0JlTGVzc1RoYW4oMTApO1xyXG4gICAgICAgICAgICBleHBlY3QoY2FjaGUuZ2V0KCduZXdLZXknKSkudG9CZURlZmluZWQoKTtcclxuICAgICAgICB9KTtcclxuICAgIH0pO1xyXG5cclxuICAgIGRlc2NyaWJlKCdTbWFydCBQcnVuaW5nJywgKCkgPT4ge1xyXG4gICAgICAgIGl0KCdzaG91bGQgcHJlZmVyIGtlZXBpbmcgZnJlcXVlbnRseSBhY2Nlc3NlZCBpdGVtcycsICgpID0+IHtcclxuICAgICAgICAgICAgLy8gQWRkIGl0ZW1zXHJcbiAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgNTsgaSsrKSB7XHJcbiAgICAgICAgICAgICAgICBjYWNoZS5zZXQoYGtleSR7aX1gLCB7IGRhdGE6ICd4Jy5yZXBlYXQoMTAwKSB9KTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgLy8gQWNjZXNzIHNvbWUgaXRlbXMgZnJlcXVlbnRseVxyXG4gICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IDEwOyBpKyspIHtcclxuICAgICAgICAgICAgICAgIGNhY2hlLmdldCgna2V5MCcpO1xyXG4gICAgICAgICAgICAgICAgY2FjaGUuZ2V0KCdrZXkxJyk7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIC8vIEZpbGwgY2FjaGUgdG8gZm9yY2UgZXZpY3Rpb25cclxuICAgICAgICAgICAgZm9yIChsZXQgaSA9IDU7IGkgPCAxMDsgaSsrKSB7XHJcbiAgICAgICAgICAgICAgICBjYWNoZS5zZXQoYGtleSR7aX1gLCB7IGRhdGE6ICd4Jy5yZXBlYXQoMTAwKSB9KTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgLy8gRnJlcXVlbnRseSBhY2Nlc3NlZCBpdGVtcyBzaG91bGQgc3RpbGwgYmUgdGhlcmVcclxuICAgICAgICAgICAgZXhwZWN0KGNhY2hlLmdldCgna2V5MCcpKS50b0JlRGVmaW5lZCgpO1xyXG4gICAgICAgICAgICBleHBlY3QoY2FjaGUuZ2V0KCdrZXkxJykpLnRvQmVEZWZpbmVkKCk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9KTtcclxuXHJcbiAgICBkZXNjcmliZSgnU3RhdGlzdGljcycsICgpID0+IHtcclxuICAgICAgICBpdCgnc2hvdWxkIHRyYWNrIGNhY2hlIHN0YXRpc3RpY3MnLCAoKSA9PiB7XHJcbiAgICAgICAgICAgIGNhY2hlLnNldCgna2V5MScsICd2YWx1ZTEnKTtcclxuICAgICAgICAgICAgY2FjaGUuZ2V0KCdrZXkxJyk7XHJcbiAgICAgICAgICAgIGNhY2hlLmdldCgna2V5MScpO1xyXG5cclxuICAgICAgICAgICAgY29uc3Qgc3RhdHMgPSBjYWNoZS5nZXRTdGF0cygpO1xyXG4gICAgICAgICAgICBleHBlY3Qoc3RhdHMpLnRvSGF2ZVByb3BlcnR5KCd0b3RhbFNpemUnKTtcclxuICAgICAgICAgICAgZXhwZWN0KHN0YXRzKS50b0hhdmVQcm9wZXJ0eSgnaXRlbUNvdW50Jyk7XHJcbiAgICAgICAgICAgIGV4cGVjdChzdGF0cykudG9IYXZlUHJvcGVydHkoJ3V0aWxpemF0aW9uJyk7XHJcbiAgICAgICAgICAgIGV4cGVjdChzdGF0cykudG9IYXZlUHJvcGVydHkoJ2F2ZXJhZ2VBY2Nlc3NDb3VudCcpO1xyXG4gICAgICAgICAgICBleHBlY3Qoc3RhdHMuaXRlbUNvdW50KS50b0JlKDEpO1xyXG4gICAgICAgICAgICBleHBlY3Qoc3RhdHMuYXZlcmFnZUFjY2Vzc0NvdW50KS50b0JlKDIpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfSk7XHJcblxyXG4gICAgZGVzY3JpYmUoJ0VkZ2UgQ2FzZXMnLCAoKSA9PiB7XHJcbiAgICAgICAgaXQoJ3Nob3VsZCBoYW5kbGUgY2lyY3VsYXIgcmVmZXJlbmNlcycsICgpID0+IHtcclxuICAgICAgICAgICAgY29uc3QgY2lyY3VsYXI6IGFueSA9IHsgbmFtZTogJ3Rlc3QnIH07XHJcbiAgICAgICAgICAgIGNpcmN1bGFyLnNlbGYgPSBjaXJjdWxhcjtcclxuXHJcbiAgICAgICAgICAgIGV4cGVjdCgoKSA9PiBjYWNoZS5zZXQoJ2NpcmN1bGFyJywgY2lyY3VsYXIpKS5ub3QudG9UaHJvdygpO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBpdCgnc2hvdWxkIGhhbmRsZSB2YXJpb3VzIGRhdGEgdHlwZXMnLCAoKSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IHRlc3RDYXNlcyA9IFtcclxuICAgICAgICAgICAgICAgIFsnc3RyaW5nJywgJ3Rlc3Qgc3RyaW5nJ10sXHJcbiAgICAgICAgICAgICAgICBbJ251bWJlcicsIDEyM10sXHJcbiAgICAgICAgICAgICAgICBbJ2Jvb2xlYW4nLCB0cnVlXSxcclxuICAgICAgICAgICAgICAgIFsnYXJyYXknLCBbMSwgMiwgM11dLFxyXG4gICAgICAgICAgICAgICAgWydkYXRlJywgbmV3IERhdGUoKV0sXHJcbiAgICAgICAgICAgICAgICBbJ3JlZ2V4cCcsIC90ZXN0L10sXHJcbiAgICAgICAgICAgICAgICBbJ2Z1bmN0aW9uJywgZnVuY3Rpb24oKSB7IHJldHVybiAndGVzdCc7IH1dXHJcbiAgICAgICAgICAgIF07XHJcblxyXG4gICAgICAgICAgICB0ZXN0Q2FzZXMuZm9yRWFjaCgoW2tleSwgdmFsdWVdKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBjYWNoZS5zZXQoa2V5IGFzIHN0cmluZywgdmFsdWUpO1xyXG4gICAgICAgICAgICAgICAgZXhwZWN0KGNhY2hlLmdldChrZXkgYXMgc3RyaW5nKSkudG9FcXVhbCh2YWx1ZSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfSk7XHJcbn0pO1xyXG4iXSwidmVyc2lvbiI6M30=