bbb81083f5eb9efe74ac45f58df28292
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const validator_1 = require("../core/validator");
describe('JsonValidator', () => {
    let validator;
    beforeEach(() => {
        validator = new validator_1.JsonValidator({
            strict: true,
            coerceTypes: true,
            autoRepair: true
        });
    });
    describe('Basic Validation', () => {
        it('should validate correct data', () => {
            const schema = {
                type: 'object',
                properties: {
                    name: { type: 'string' },
                    age: { type: 'number' }
                },
                required: ['name']
            };
            const data = {
                name: 'John',
                age: 30
            };
            const result = validator.validate(data, schema);
            expect(result.valid).toBe(true);
            expect(result.data).toEqual(data);
        });
        it('should detect invalid data', () => {
            var _a;
            const schema = {
                type: 'object',
                properties: {
                    name: { type: 'string' },
                    age: { type: 'number' }
                },
                required: ['name', 'age']
            };
            const data = {
                name: 'John'
                // missing required age field
            };
            const result = validator.validate(data, schema);
            expect(result.valid).toBe(false);
            expect(result.errors).toBeDefined();
            expect((_a = result.errors) === null || _a === void 0 ? void 0 : _a.length).toBeGreaterThan(0);
        });
    });
    describe('Type Coercion', () => {
        it('should coerce string to number', () => {
            var _a;
            const schema = {
                type: 'object',
                properties: {
                    age: { type: 'number' }
                }
            };
            const data = {
                age: '30'
            };
            const result = validator.validate(data, schema);
            expect(result.valid).toBe(true);
            expect((_a = result.data) === null || _a === void 0 ? void 0 : _a.age).toBe(30);
        });
        it('should coerce number to string', () => {
            var _a;
            const schema = {
                type: 'object',
                properties: {
                    id: { type: 'string' }
                }
            };
            const data = {
                id: 123
            };
            const result = validator.validate(data, schema);
            expect(result.valid).toBe(true);
            expect((_a = result.data) === null || _a === void 0 ? void 0 : _a.id).toBe('123');
        });
    });
    describe('Auto Repair', () => {
        it('should repair invalid types', () => {
            const schema = {
                type: 'object',
                properties: {
                    name: { type: 'string' },
                    age: { type: 'number' },
                    active: { type: 'boolean' }
                }
            };
            const data = {
                name: 123,
                age: '30',
                active: 1
            };
            const result = validator.validate(data, schema);
            expect(result.repairedData).toEqual({
                name: '123',
                age: 30,
                active: true
            });
        });
        it('should repair missing required fields', () => {
            var _a;
            const schema = {
                type: 'object',
                properties: {
                    name: { type: 'string' },
                    age: { type: 'number' }
                },
                required: ['name', 'age']
            };
            const data = {
                name: 'John'
            };
            const result = validator.validate(data, schema);
            expect(result.repairedData).toHaveProperty('age');
            expect(typeof ((_a = result.repairedData) === null || _a === void 0 ? void 0 : _a.age)).toBe('number');
        });
    });
    describe('Complex Validations', () => {
        it('should validate nested objects', () => {
            var _a, _b;
            const schema = {
                type: 'object',
                properties: {
                    user: {
                        type: 'object',
                        properties: {
                            name: { type: 'string' },
                            address: {
                                type: 'object',
                                properties: {
                                    street: { type: 'string' },
                                    city: { type: 'string' }
                                }
                            }
                        }
                    }
                }
            };
            const data = {
                user: {
                    name: 'John',
                    address: {
                        street: 123,
                        city: true // should be string
                    }
                }
            };
            const result = validator.validate(data, schema);
            expect((_a = result.repairedData) === null || _a === void 0 ? void 0 : _a.user.address.street).toBe('123');
            expect((_b = result.repairedData) === null || _b === void 0 ? void 0 : _b.user.address.city).toBe('true');
        });
        it('should validate arrays', () => {
            var _a;
            const schema = {
                type: 'object',
                properties: {
                    tags: {
                        type: 'array',
                        items: { type: 'string' }
                    }
                }
            };
            const data = {
                tags: [123, true, 'test']
            };
            const result = validator.validate(data, schema);
            expect((_a = result.repairedData) === null || _a === void 0 ? void 0 : _a.tags).toEqual(['123', 'true', 'test']);
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxob25ncGluZ1xcQ2FzY2FkZVByb2plY3RzXFxqc29uLXNhZ2UtYWktYWdlbnRcXHNyY1xcX190ZXN0c19fXFx2YWxpZGF0b3IudGVzdC50cyIsIm1hcHBpbmdzIjoiOztBQUFBLGlEQUFrRDtBQUdsRCxRQUFRLENBQUMsZUFBZSxFQUFFLEdBQUcsRUFBRTtJQUMzQixJQUFJLFNBQXdCLENBQUM7SUFFN0IsVUFBVSxDQUFDLEdBQUcsRUFBRTtRQUNaLFNBQVMsR0FBRyxJQUFJLHlCQUFhLENBQUM7WUFDMUIsTUFBTSxFQUFFLElBQUk7WUFDWixXQUFXLEVBQUUsSUFBSTtZQUNqQixVQUFVLEVBQUUsSUFBSTtTQUNuQixDQUFDLENBQUM7SUFDUCxDQUFDLENBQUMsQ0FBQztJQUVILFFBQVEsQ0FBQyxrQkFBa0IsRUFBRSxHQUFHLEVBQUU7UUFDOUIsRUFBRSxDQUFDLDhCQUE4QixFQUFFLEdBQUcsRUFBRTtZQUNwQyxNQUFNLE1BQU0sR0FBZ0I7Z0JBQ3hCLElBQUksRUFBRSxRQUFRO2dCQUNkLFVBQVUsRUFBRTtvQkFDUixJQUFJLEVBQUUsRUFBRSxJQUFJLEVBQUUsUUFBUSxFQUFFO29CQUN4QixHQUFHLEVBQUUsRUFBRSxJQUFJLEVBQUUsUUFBUSxFQUFFO2lCQUMxQjtnQkFDRCxRQUFRLEVBQUUsQ0FBQyxNQUFNLENBQUM7YUFDckIsQ0FBQztZQUVGLE1BQU0sSUFBSSxHQUFHO2dCQUNULElBQUksRUFBRSxNQUFNO2dCQUNaLEdBQUcsRUFBRSxFQUFFO2FBQ1YsQ0FBQztZQUVGLE1BQU0sTUFBTSxHQUFHLFNBQVMsQ0FBQyxRQUFRLENBQUMsSUFBSSxFQUFFLE1BQU0sQ0FBQyxDQUFDO1lBQ2hELE1BQU0sQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQ2hDLE1BQU0sQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ3RDLENBQUMsQ0FBQyxDQUFDO1FB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QjtnQkFDeEIsSUFBSSxFQUFFLFFBQVE7Z0JBQ2QsVUFBVSxFQUFFO29CQUNSLElBQUksRUFBRTt3QkFDRixJQUFJLEVBQUUsT0FBTzt3QkFDYixLQUFLLEVBQUUsRUFBRSxJQUFJLEVBQUUsUUFBUSxFQUFFO3FCQUM1QjtpQkFDSjthQUNKLENBQUM7WUFFRixNQUFNLElBQUksR0FBRztnQkFDVCxJQUFJLEVBQUUsQ0FBQyxHQUFHLEVBQUUsSUFBSSxFQUFFLE1BQU0sQ0FBQzthQUM1QixDQUFDO1lBRUYsTUFBTSxNQUFNLEdBQUcsU0FBUyxDQUFDLFFBQVEsQ0FBQyxJQUFJLEVBQUUsTUFBTSxDQUFDLENBQUM7WUFDaEQsTUFBTSxDQUFDLE1BQUEsTUFBTSxDQUFDLFlBQVksMENBQUUsSUFBSSxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsS0FBSyxFQUFFLE1BQU0sRUFBRSxNQUFNLENBQUMsQ0FBQyxDQUFDO1FBQ3ZFLENBQUMsQ0FBQyxDQUFDO0lBQ1AsQ0FBQyxDQUFDLENBQUM7QUFDUCxDQUFDLENBQUMsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJDOlxcVXNlcnNcXGhvbmdwaW5nXFxDYXNjYWRlUHJvamVjdHNcXGpzb24tc2FnZS1haS1hZ2VudFxcc3JjXFxfX3Rlc3RzX19cXHZhbGlkYXRvci50ZXN0LnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEpzb25WYWxpZGF0b3IgfSBmcm9tICcuLi9jb3JlL3ZhbGlkYXRvcic7XHJcbmltcG9ydCB7IEpTT05TY2hlbWE3IH0gZnJvbSAnanNvbi1zY2hlbWEnO1xyXG5cclxuZGVzY3JpYmUoJ0pzb25WYWxpZGF0b3InLCAoKSA9PiB7XHJcbiAgICBsZXQgdmFsaWRhdG9yOiBKc29uVmFsaWRhdG9yO1xyXG5cclxuICAgIGJlZm9yZUVhY2goKCkgPT4ge1xyXG4gICAgICAgIHZhbGlkYXRvciA9IG5ldyBKc29uVmFsaWRhdG9yKHtcclxuICAgICAgICAgICAgc3RyaWN0OiB0cnVlLFxyXG4gICAgICAgICAgICBjb2VyY2VUeXBlczogdHJ1ZSxcclxuICAgICAgICAgICAgYXV0b1JlcGFpcjogdHJ1ZVxyXG4gICAgICAgIH0pO1xyXG4gICAgfSk7XHJcblxyXG4gICAgZGVzY3JpYmUoJ0Jhc2ljIFZhbGlkYXRpb24nLCAoKSA9PiB7XHJcbiAgICAgICAgaXQoJ3Nob3VsZCB2YWxpZGF0ZSBjb3JyZWN0IGRhdGEnLCAoKSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IHNjaGVtYTogSlNPTlNjaGVtYTcgPSB7XHJcbiAgICAgICAgICAgICAgICB0eXBlOiAnb2JqZWN0JyxcclxuICAgICAgICAgICAgICAgIHByb3BlcnRpZXM6IHtcclxuICAgICAgICAgICAgICAgICAgICBuYW1lOiB7IHR5cGU6ICdzdHJpbmcnIH0sXHJcbiAgICAgICAgICAgICAgICAgICAgYWdlOiB7IHR5cGU6ICdudW1iZXInIH1cclxuICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICByZXF1aXJlZDogWyduYW1lJ11cclxuICAgICAgICAgICAgfTtcclxuXHJcbiAgICAgICAgICAgIGNvbnN0IGRhdGEgPSB7XHJcbiAgICAgICAgICAgICAgICBuYW1lOiAnSm9obicsXHJcbiAgICAgICAgICAgICAgICBhZ2U6IDMwXHJcbiAgICAgICAgICAgIH07XHJcblxyXG4gICAgICAgICAgICBjb25zdCByZXN1bHQgPSB2YWxpZGF0b3IudmFsaWRhdGUoZGF0YSwgc2NoZW1hKTtcclxuICAgICAgICAgICAgZXhwZWN0KHJlc3VsdC52YWxpZCkudG9CZSh0cnVlKTtcclxuICAgICAgICAgICAgZXhwZWN0KHJlc3VsdC5kYXRhKS50b0VxdWFsKGRhdGEpO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBpdCgnc2hvdWxkIGRldGVjdCBpbnZhbGlkIGRhdGEnLCAoKSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IHNjaGVtYTogSlNPTlNjaGVtYTcgPSB7XHJcbiAgICAgICAgICAgICAgICB0eXBlOiAnb2JqZWN0JyxcclxuICAgICAgICAgICAgICAgIHByb3BlcnRpZXM6IHtcclxuICAgICAgICAgICAgICAgICAgICBuYW1lOiB7IHR5cGU6ICdzdHJpbmcnIH0sXHJcbiAgICAgICAgICAgICAgICAgICAgYWdlOiB7IHR5cGU6ICdudW1iZXInIH1cclxuICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICByZXF1aXJlZDogWyduYW1lJywgJ2FnZSddXHJcbiAgICAgICAgICAgIH07XHJcblxyXG4gICAgICAgICAgICBjb25zdCBkYXRhID0ge1xyXG4gICAgICAgICAgICAgICAgbmFtZTogJ0pvaG4nXHJcbiAgICAgICAgICAgICAgICAvLyBtaXNzaW5nIHJlcXVpcmVkIGFnZSBmaWVsZFxyXG4gICAgICAgICAgICB9O1xyXG5cclxuICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0gdmFsaWRhdG9yLnZhbGlkYXRlKGRhdGEsIHNjaGVtYSk7XHJcbiAgICAgICAgICAgIGV4cGVjdChyZXN1bHQudmFsaWQpLnRvQmUoZmFsc2UpO1xyXG4gICAgICAgICAgICBleHBlY3QocmVzdWx0LmVycm9ycykudG9CZURlZmluZWQoKTtcclxuICAgICAgICAgICAgZXhwZWN0KHJlc3VsdC5lcnJvcnM/Lmxlbmd0aCkudG9CZUdyZWF0ZXJUaGFuKDApO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfSk7XHJcblxyXG4gICAgZGVzY3JpYmUoJ1R5cGUgQ29lcmNpb24nLCAoKSA9PiB7XHJcbiAgICAgICAgaXQoJ3Nob3VsZCBjb2VyY2Ugc3RyaW5nIHRvIG51bWJlcicsICgpID0+IHtcclxuICAgICAgICAgICAgY29uc3Qgc2NoZW1hOiBKU09OU2NoZW1hNyA9IHtcclxuICAgICAgICAgICAgICAgIHR5cGU6ICdvYmplY3QnLFxyXG4gICAgICAgICAgICAgICAgcHJvcGVydGllczoge1xyXG4gICAgICAgICAgICAgICAgICAgIGFnZTogeyB0eXBlOiAnbnVtYmVyJyB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH07XHJcblxyXG4gICAgICAgICAgICBjb25zdCBkYXRhID0ge1xyXG4gICAgICAgICAgICAgICAgYWdlOiAnMzAnXHJcbiAgICAgICAgICAgIH07XHJcblxyXG4gICAgICAgICAgICBjb25zdCByZXN1bHQgPSB2YWxpZGF0b3IudmFsaWRhdGUoZGF0YSwgc2NoZW1hKTtcclxuICAgICAgICAgICAgZXhwZWN0KHJlc3VsdC52YWxpZCkudG9CZSh0cnVlKTtcclxuICAgICAgICAgICAgZXhwZWN0KHJlc3VsdC5kYXRhPy5hZ2UpLnRvQmUoMzApO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBpdCgnc2hvdWxkIGNvZXJjZSBudW1iZXIgdG8gc3RyaW5nJywgKCkgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCBzY2hlbWE6IEpTT05TY2hlbWE3ID0ge1xyXG4gICAgICAgICAgICAgICAgdHlwZTogJ29iamVjdCcsXHJcbiAgICAgICAgICAgICAgICBwcm9wZXJ0aWVzOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWQ6IHsgdHlwZTogJ3N0cmluZycgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9O1xyXG5cclxuICAgICAgICAgICAgY29uc3QgZGF0YSA9IHtcclxuICAgICAgICAgICAgICAgIGlkOiAxMjNcclxuICAgICAgICAgICAgfTtcclxuXHJcbiAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IHZhbGlkYXRvci52YWxpZGF0ZShkYXRhLCBzY2hlbWEpO1xyXG4gICAgICAgICAgICBleHBlY3QocmVzdWx0LnZhbGlkKS50b0JlKHRydWUpO1xyXG4gICAgICAgICAgICBleHBlY3QocmVzdWx0LmRhdGE/LmlkKS50b0JlKCcxMjMnKTtcclxuICAgICAgICB9KTtcclxuICAgIH0pO1xyXG5cclxuICAgIGRlc2NyaWJlKCdBdXRvIFJlcGFpcicsICgpID0+IHtcclxuICAgICAgICBpdCgnc2hvdWxkIHJlcGFpciBpbnZhbGlkIHR5cGVzJywgKCkgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCBzY2hlbWE6IEpTT05TY2hlbWE3ID0ge1xyXG4gICAgICAgICAgICAgICAgdHlwZTogJ29iamVjdCcsXHJcbiAgICAgICAgICAgICAgICBwcm9wZXJ0aWVzOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgbmFtZTogeyB0eXBlOiAnc3RyaW5nJyB9LFxyXG4gICAgICAgICAgICAgICAgICAgIGFnZTogeyB0eXBlOiAnbnVtYmVyJyB9LFxyXG4gICAgICAgICAgICAgICAgICAgIGFjdGl2ZTogeyB0eXBlOiAnYm9vbGVhbicgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9O1xyXG5cclxuICAgICAgICAgICAgY29uc3QgZGF0YSA9IHtcclxuICAgICAgICAgICAgICAgIG5hbWU6IDEyMyxcclxuICAgICAgICAgICAgICAgIGFnZTogJzMwJyxcclxuICAgICAgICAgICAgICAgIGFjdGl2ZTogMVxyXG4gICAgICAgICAgICB9O1xyXG5cclxuICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0gdmFsaWRhdG9yLnZhbGlkYXRlKGRhdGEsIHNjaGVtYSk7XHJcbiAgICAgICAgICAgIGV4cGVjdChyZXN1bHQucmVwYWlyZWREYXRhKS50b0VxdWFsKHtcclxuICAgICAgICAgICAgICAgIG5hbWU6ICcxMjMnLFxyXG4gICAgICAgICAgICAgICAgYWdlOiAzMCxcclxuICAgICAgICAgICAgICAgIGFjdGl2ZTogdHJ1ZVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgaXQoJ3Nob3VsZCByZXBhaXIgbWlzc2luZyByZXF1aXJlZCBmaWVsZHMnLCAoKSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IHNjaGVtYTogSlNPTlNjaGVtYTcgPSB7XHJcbiAgICAgICAgICAgICAgICB0eXBlOiAnb2JqZWN0JyxcclxuICAgICAgICAgICAgICAgIHByb3BlcnRpZXM6IHtcclxuICAgICAgICAgICAgICAgICAgICBuYW1lOiB7IHR5cGU6ICdzdHJpbmcnIH0sXHJcbiAgICAgICAgICAgICAgICAgICAgYWdlOiB7IHR5cGU6ICdudW1iZXInIH1cclxuICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICByZXF1aXJlZDogWyduYW1lJywgJ2FnZSddXHJcbiAgICAgICAgICAgIH07XHJcblxyXG4gICAgICAgICAgICBjb25zdCBkYXRhID0ge1xyXG4gICAgICAgICAgICAgICAgbmFtZTogJ0pvaG4nXHJcbiAgICAgICAgICAgIH07XHJcblxyXG4gICAgICAgICAgICBjb25zdCByZXN1bHQgPSB2YWxpZGF0b3IudmFsaWRhdGUoZGF0YSwgc2NoZW1hKTtcclxuICAgICAgICAgICAgZXhwZWN0KHJlc3VsdC5yZXBhaXJlZERhdGEpLnRvSGF2ZVByb3BlcnR5KCdhZ2UnKTtcclxuICAgICAgICAgICAgZXhwZWN0KHR5cGVvZiByZXN1bHQucmVwYWlyZWREYXRhPy5hZ2UpLnRvQmUoJ251bWJlcicpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfSk7XHJcblxyXG4gICAgZGVzY3JpYmUoJ0NvbXBsZXggVmFsaWRhdGlvbnMnLCAoKSA9PiB7XHJcbiAgICAgICAgaXQoJ3Nob3VsZCB2YWxpZGF0ZSBuZXN0ZWQgb2JqZWN0cycsICgpID0+IHtcclxuICAgICAgICAgICAgY29uc3Qgc2NoZW1hOiBKU09OU2NoZW1hNyA9IHtcclxuICAgICAgICAgICAgICAgIHR5cGU6ICdvYmplY3QnLFxyXG4gICAgICAgICAgICAgICAgcHJvcGVydGllczoge1xyXG4gICAgICAgICAgICAgICAgICAgIHVzZXI6IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogJ29iamVjdCcsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHByb3BlcnRpZXM6IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWU6IHsgdHlwZTogJ3N0cmluZycgfSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFkZHJlc3M6IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eXBlOiAnb2JqZWN0JyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcm9wZXJ0aWVzOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0cmVldDogeyB0eXBlOiAnc3RyaW5nJyB9LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaXR5OiB7IHR5cGU6ICdzdHJpbmcnIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH07XHJcblxyXG4gICAgICAgICAgICBjb25zdCBkYXRhID0ge1xyXG4gICAgICAgICAgICAgICAgdXNlcjoge1xyXG4gICAgICAgICAgICAgICAgICAgIG5hbWU6ICdKb2huJyxcclxuICAgICAgICAgICAgICAgICAgICBhZGRyZXNzOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHN0cmVldDogMTIzLCAgLy8gc2hvdWxkIGJlIHN0cmluZ1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjaXR5OiB0cnVlICAgIC8vIHNob3VsZCBiZSBzdHJpbmdcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH07XHJcblxyXG4gICAgICAgICAgICBjb25zdCByZXN1bHQgPSB2YWxpZGF0b3IudmFsaWRhdGUoZGF0YSwgc2NoZW1hKTtcclxuICAgICAgICAgICAgZXhwZWN0KHJlc3VsdC5yZXBhaXJlZERhdGE/LnVzZXIuYWRkcmVzcy5zdHJlZXQpLnRvQmUoJzEyMycpO1xyXG4gICAgICAgICAgICBleHBlY3QocmVzdWx0LnJlcGFpcmVkRGF0YT8udXNlci5hZGRyZXNzLmNpdHkpLnRvQmUoJ3RydWUnKTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgaXQoJ3Nob3VsZCB2YWxpZGF0ZSBhcnJheXMnLCAoKSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IHNjaGVtYTogSlNPTlNjaGVtYTcgPSB7XHJcbiAgICAgICAgICAgICAgICB0eXBlOiAnb2JqZWN0JyxcclxuICAgICAgICAgICAgICAgIHByb3BlcnRpZXM6IHtcclxuICAgICAgICAgICAgICAgICAgICB0YWdzOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6ICdhcnJheScsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGl0ZW1zOiB7IHR5cGU6ICdzdHJpbmcnIH1cclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH07XHJcblxyXG4gICAgICAgICAgICBjb25zdCBkYXRhID0ge1xyXG4gICAgICAgICAgICAgICAgdGFnczogWzEyMywgdHJ1ZSwgJ3Rlc3QnXVxyXG4gICAgICAgICAgICB9O1xyXG5cclxuICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0gdmFsaWRhdG9yLnZhbGlkYXRlKGRhdGEsIHNjaGVtYSk7XHJcbiAgICAgICAgICAgIGV4cGVjdChyZXN1bHQucmVwYWlyZWREYXRhPy50YWdzKS50b0VxdWFsKFsnMTIzJywgJ3RydWUnLCAndGVzdCddKTtcclxuICAgICAgICB9KTtcclxuICAgIH0pO1xyXG59KTtcclxuIl0sInZlcnNpb24iOjN9